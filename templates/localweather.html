<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lokal V√¶rmelding - L√∏renskog Skytterlag</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .weather-section {
            margin-bottom: 20px;
        }
        .weather-section h2 {
            font-size: 14px;
            margin-bottom: 4px;
            color: #666;
            font-weight: normal;
        }
        .weather-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .weather-table th {
            text-align: left;
            padding: 8px 6px;
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
            font-size: 12px;
        }
        .weather-table th:nth-child(3) {
            text-align: right;
        }
        .weather-table td {
            padding: 6px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }
        .weather-table td:nth-child(3) {
            text-align: right;
        }
        .weather-table td:nth-child(4) {
            text-align: left;
        }
        .weather-table tr:hover {
            background: #f8f9fa;
        }
        .wind-arrow {
            display: inline-block;
            margin-right: 4px;
        }
        .expand-button {
            padding: 6px 14px;
            font-size: 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 8px;
            background: #FFA500;
            color: white;
            border: none;
        }
        .expand-button:hover {
            background: #e69500;
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        .error {
            color: #dc3545;
            text-align: center;
            font-style: italic;
            padding: 20px;
        }
        .weather-icon {
            font-size: 1.2em;
        }
        .preset-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .preset-btn {
            padding: 8px 16px;
            background: #FFA500;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .preset-btn:hover {
            background: #e69500;
        }
        .preset-btn.active {
            background: #e69500;
            font-weight: bold;
        }
        .custom-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .custom-dialog.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .custom-dialog-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            min-width: 300px;
        }
        .custom-dialog h3 {
            margin-top: 0;
            color: #333;
        }
        .custom-dialog input {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .custom-dialog-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .custom-dialog-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .custom-dialog-btn.primary {
            background: #FFA500;
            color: white;
        }
        .custom-dialog-btn.secondary {
            background: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <h1>
                <img src="{{ url_for('static', filename='logo.png') }}" alt="L√∏renskog Skytterlag Logo" class="header-logo">
                <span>Lokal V√¶rmelding</span>
            </h1>
            <div class="header-controls">
                <button id="backBtn" class="btn btn-secondary" title="Tilbake til hovedsiden" onclick="window.location.href='/'">
                    <i class="fas fa-arrow-left"></i> Tilbake
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="weather-container">
                
                <!-- Preset Buttons -->
                <div class="preset-buttons">
                    <button class="preset-btn active" onclick="setTimePeriod('now')">Neste 5 timer</button>
                    <button class="preset-btn" onclick="setTimePeriod('tomorrow-morning')">I morgen 10-15</button>
                    <button class="preset-btn" onclick="setTimePeriod('tomorrow-afternoon')">I morgen 16-21</button>
                    <button class="preset-btn" onclick="showCustomDialog()">Egendefinert periode</button>
                </div>
                
                <!-- Standplass -->
                <div class="weather-section" id="weather-standplass">
                    <h2>V√¶rmelding (Standplass)</h2>
                    <div class="loading">Laster v√¶rmelding...</div>
                </div>

                <!-- 200m -->
                <div class="weather-section" id="weather-200m">
                    <h2>V√¶rmelding (200m)</h2>
                    <div class="loading">Laster v√¶rmelding...</div>
                </div>

                <!-- 400m -->
                <div class="weather-section" id="weather-400m">
                    <h2>V√¶rmelding (400m)</h2>
                    <div class="loading">Laster v√¶rmelding...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Custom Time Dialog -->
    <div class="custom-dialog" id="customDialog">
        <div class="custom-dialog-content">
            <h3>Egendefinert tidsperiode</h3>
            <label>Start tid:</label>
            <input type="datetime-local" id="startTime">
            <label>Slutt tid:</label>
            <input type="datetime-local" id="endTime">
            <div class="custom-dialog-buttons">
                <button class="custom-dialog-btn primary" onclick="setCustomTimePeriod()">OK</button>
                <button class="custom-dialog-btn secondary" onclick="hideCustomDialog()">Avbryt</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        // V√¶rmelding posisjoner
        const weatherPositions = {
            '400m': { lat: 59.88915033599055, lon: 10.966211684095603 },
            '200m': { lat: 59.89053674227015, lon: 10.968735389001138 },
            'standplass': { lat: 59.89171431835379, lon: 10.971989146363413 }
        };

        // OpenMeteo API (gratis, ingen API-n√∏kkel n√∏dvendig)
        const API_BASE_URL = 'https://api.open-meteo.com/v1/forecast';

        // Aktuell tidsperiode
        let currentTimePeriod = {
            start: new Date(),
            end: new Date(Date.now() + 5 * 60 * 60 * 1000), // 5 timer fra n√•
            label: 'Neste 5 timer'
        };

        // Vindretning tekst
        function windDirectionText(deg) {
            const directions = ['N', 'N√ò', '√ò', 'S√ò', 'S', 'SV', 'V', 'NV'];
            const index = Math.round(deg / 45) % 8;
            return directions[index];
        }

        // Vindpil
        function windArrow(deg) {
            return `<span class="wind-arrow" style="transform: rotate(${deg}deg);">‚Üë</span>`;
        }

        // V√¶rikon basert p√• WMO kode
        function weatherIcon(code) {
            const icons = {
                0: '‚òÄÔ∏è', // Klar himmel
                1: 'üå§Ô∏è', // Hovedsakelig klar
                2: '‚õÖ', // Delvis skyet
                3: '‚òÅÔ∏è', // Overskyet
                45: 'üå´Ô∏è', // T√•ke
                48: 'üå´Ô∏è', // T√•ke med rim
                51: 'üåßÔ∏è', // Lett regn
                53: 'üåßÔ∏è', // Moderat regn
                55: 'üåßÔ∏è', // Kraftig regn
                61: 'üåßÔ∏è', // Lett regn
                63: 'üåßÔ∏è', // Moderat regn
                65: 'üåßÔ∏è', // Kraftig regn
                71: 'üå®Ô∏è', // Lett sn√∏
                73: 'üå®Ô∏è', // Moderat sn√∏
                75: 'üå®Ô∏è', // Kraftig sn√∏
                95: '‚õàÔ∏è', // Torden
                96: '‚õàÔ∏è', // Torden med lett hagl
                99: '‚õàÔ∏è'  // Torden med kraftig hagl
            };
            return icons[code] || 'üå§Ô∏è';
        }

        // Sett tidsperiode
        function setTimePeriod(period) {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);

            switch(period) {
                case 'now':
                    currentTimePeriod = {
                        start: now,
                        end: new Date(now.getTime() + 5 * 60 * 60 * 1000),
                        label: 'Neste 5 timer'
                    };
                    break;
                case 'tomorrow-morning':
                    const morningStart = new Date(tomorrow);
                    morningStart.setHours(10, 0, 0, 0);
                    const morningEnd = new Date(tomorrow);
                    morningEnd.setHours(15, 0, 0, 0);
                    currentTimePeriod = {
                        start: morningStart,
                        end: morningEnd,
                        label: 'I morgen 10-15'
                    };
                    break;
                case 'tomorrow-afternoon':
                    const afternoonStart = new Date(tomorrow);
                    afternoonStart.setHours(16, 0, 0, 0);
                    const afternoonEnd = new Date(tomorrow);
                    afternoonEnd.setHours(21, 0, 0, 0);
                    currentTimePeriod = {
                        start: afternoonStart,
                        end: afternoonEnd,
                        label: 'I morgen 16-21'
                    };
                    break;
            }

            // Oppdater aktive knapp
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Last v√¶rmelding p√• nytt
            loadAllWeather();
        }

        // Vis custom dialog
        function showCustomDialog() {
            const dialog = document.getElementById('customDialog');
            dialog.classList.add('active');
            
            // Sett default verdier
            const now = new Date();
            const startTime = new Date(now.getTime() + 60 * 60 * 1000); // 1 time fra n√•
            const endTime = new Date(now.getTime() + 6 * 60 * 60 * 1000); // 6 timer fra n√•
            
            document.getElementById('startTime').value = startTime.toISOString().slice(0, 16);
            document.getElementById('endTime').value = endTime.toISOString().slice(0, 16);
        }

        // Skjul custom dialog
        function hideCustomDialog() {
            document.getElementById('customDialog').classList.remove('active');
        }

        // Sett custom tidsperiode
        function setCustomTimePeriod() {
            const startTime = new Date(document.getElementById('startTime').value);
            const endTime = new Date(document.getElementById('endTime').value);
            
            if (startTime >= endTime) {
                alert('Starttid m√• v√¶re f√∏r sluttid!');
                return;
            }
            
            currentTimePeriod = {
                start: startTime,
                end: endTime,
                label: `${startTime.toLocaleDateString('no-NO')} ${startTime.toLocaleTimeString('no-NO', {hour: '2-digit', minute: '2-digit'})} - ${endTime.toLocaleTimeString('no-NO', {hour: '2-digit', minute: '2-digit'})}`
            };
            
            hideCustomDialog();
            loadAllWeather();
        }

        // Hent v√¶rmelding for en posisjon
        async function fetchWeather(lat, lon, positionId) {
            try {
                const url = `${API_BASE_URL}?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,wind_speed_10m,wind_direction_10m,weather_code,precipitation&timezone=Europe/Oslo`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                updateWeatherSection(positionId, data);
            } catch (error) {
                console.error(`Error fetching weather for ${positionId}:`, error);
                showError(positionId, error.message);
            }
        }

        // Oppdater v√¶rmelding-seksjon
        function updateWeatherSection(positionId, data) {
            const section = document.getElementById(`weather-${positionId}`);
            if (!section) return;

            // Hent data for valgt tidsperiode
            const hourlyData = [];
            const startTime = currentTimePeriod.start;
            const endTime = currentTimePeriod.end;
            
            for (let time = new Date(startTime); time <= endTime; time.setHours(time.getHours() + 1)) {
                const timeString = time.toISOString().slice(0, 13) + ':00';
                const index = data.hourly.time.indexOf(timeString);
                
                if (index !== -1) {
                    hourlyData.push({
                        time: timeString,
                        temp: Math.round(data.hourly.temperature_2m[index]),
                        windSpeed: Math.round(data.hourly.wind_speed_10m[index] / 3.6), // Konverterer fra km/h til m/s
                        windDir: data.hourly.wind_direction_10m[index],
                        weatherCode: data.hourly.weather_code[index],
                        precipitation: data.hourly.precipitation[index]
                    });
                }
            }

            if (hourlyData.length === 0) {
                section.innerHTML = `
                    <h2>V√¶rmelding (${positionId.toUpperCase()}) - ${currentTimePeriod.label}</h2>
                    <div class="error">Ingen data tilgjengelig for valgt tidsperiode</div>
                `;
                return;
            }

            // Opprett tabell
            const tableHTML = `
                <table class="weather-table">
                    <thead>
                        <tr>
                            <th>Tid</th>
                            <th>Temp</th>
                            <th>Vind (m/s)</th>
                            <th>Retning</th>
                            <th>V√¶r</th>
                            <th>Nedb√∏r (mm)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${hourlyData.map(h => `
                            <tr>
                                <td>${new Date(h.time).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", hour12: false })}</td>
                                <td>${h.temp}¬∞C</td>
                                <td>${h.windSpeed}</td>
                                <td>
                                    ${windArrow(h.windDir)}
                                    ${windDirectionText(h.windDir)}
                                </td>
                                <td class="weather-icon">${weatherIcon(h.weatherCode)}</td>
                                <td>${h.precipitation}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            section.innerHTML = `
                <h2>V√¶rmelding (${positionId.toUpperCase()}) - ${currentTimePeriod.label}</h2>
                ${tableHTML}
            `;
        }

        // Vis feilmelding
        function showError(positionId, message) {
            const section = document.getElementById(`weather-${positionId}`);
            if (!section) return;
            
            section.innerHTML = `
                <h2>V√¶rmelding (${positionId.toUpperCase()}) - ${currentTimePeriod.label}</h2>
                <div class="error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Kunne ikke laste v√¶rmelding</p>
                    <small>${message}</small>
                </div>
            `;
        }

        // Last alle v√¶rmeldinger
        async function loadAllWeather() {
            console.log('Laster v√¶rmelding for alle posisjoner...');
            
            // Hent v√¶rmelding for hver posisjon
            for (const [positionId, coords] of Object.entries(weatherPositions)) {
                await fetchWeather(coords.lat, coords.lon, positionId);
            }
        }

        // Last v√¶rmelding n√•r siden lastes
        document.addEventListener('DOMContentLoaded', loadAllWeather);

        // Lukk dialog n√•r man klikker utenfor
        document.getElementById('customDialog').addEventListener('click', function(e) {
            if (e.target === this) {
                hideCustomDialog();
            }
        });
    </script>
</body>
</html>
